# H1
Tehtävänanto: Tero Karvinen, Lari Iso-Anttila, https://terokarvinen.com/verkkoon-tunkeutuminen-ja-tiedustelu/

***
## Tehtävä x
> x) Lue/katso/kuuntele ja tiivistä.

i) Karvinen 2025: Wireshark - Getting Started

Ohjeistetaan wiresharkin latausta, itsellä se oli jo ladattuna kalilla.

ii) Karvinen 2025: Network Interface Names on Linux

- wl -> wireless
- en -> ethernet
- lo -> loopback

***
## Tehtävä a
> a) Linux. Asenna Debian tai Kali Linux virtuaalikoneeseen.

Asennettuna Kali qemulle kali.org ohjeiden[^2] avulla.

***
## Tehtävä b
> b) Ei voi kalastaa. Osoita, että pystyt katkaisemaan ja palauttamaan virtuaalikoneen Internet-yhteyden.

Käytän HTB:ta varten skriptiä, joka ei päästä `eth0`:sta paketteja ulos muualle kuin
VPN tunneliin `tun0` (kohteisiin) menevät.

```bash
$ cat blockallpackets
#!/bin/bash
VPN_HOST=edge-eu-academy-2.hackthebox.eu
VPN_IP=$(getent hosts $VPN_HOST | awk '{print $1}')

sudo iptables -F OUTPUT
sudo iptables -A OUTPUT -o eth0 -p udp --dport 1337 -d $VPN_IP -j ACCEPT
sudo iptables -A OUTPUT -o eth0 -j DROP
sudo iptables -A INPUT  -i tun0 -j ACCEPT
sudo iptables -A OUTPUT -o tun0 -j ACCEPT

$ cat stopblockallpackets
#!/bin/bash
sudo iptables -F OUTPUT
sudo iptables -P OUTPUT ACCEPT
```

ja testit:

```bash
# ilman blokkeja toimii
$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=119 time=8.55 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=119 time=9.27 ms
^C
--- 8.8.8.8 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 8.549/8.910/9.272/0.361 ms

# block päälle, ei mene pingit läpi
$ ./blockallpackets
$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
^C
--- 8.8.8.8 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2032ms
```

***
## Tehtävä c
> c) Wireshark. Asenna Wireshark. Sieppaa liikennettä Wiresharkilla. (Vain omaa liikennettäsi. Voit käyttää tähän esimerkiksi virtuaalikonetta).

Tämä liikenteen sieppaaminen tapahtuu seuraavassa tehtävässä

***
## Tehtävä d
> d) Oikeesti TCP/IP. Osoita TCP/IP-mallin neljä kerrosta yhdestä siepatusta paketista. Voit selityksen tueksi laatikoida ne ruutukaappauksesta. (Voit käyttää vastauksesi osana ruutukaappaustasi h0-tehtävästä, mutta tässä tehtävässä tarvitaan myös sanallinen selitys.)

Selitin tätä vähän enemmän H0:ssa[^3]

***
## Tehtävä e
> e) Mitäs tuli surffattua? Avaa surfing-secure.pcap. Tutustu siihen pintapuolisesti ja kuvaile, millainen kaappaus on kyseessä. Tässä siis vain lyhyesti ja yleisellä tasolla. Voit esimerkiksi vilkaista, montako konetta näkyy, mitä protokollia pistää silmään. Määrästä voit arvioida esimerkiksi pakettien lukumäärää, kaappauksen kokoa ja kestoa.

Kaappauksen kesto `17:28:09.043495 - 17:28:16.579175`, n. 7 sekuntia ja 283 pakettia kaapattu.

```bash
$ tcpdump --count -r surfing-secure.pcap
reading from file surfing-secure.pcap, link-type EN10MB (Ethernet), snapshot length 262144
283 packets
```

Näyttäisi siltä, että alkuun osoite `192.168.122.7` kysyy tämän gatewaylta mikä IP-osoite
`www.google.com`:lla on.

```bash
$ tcpdump -nn -r surfing-secure.pcap
reading from file surfing-secure.pcap, link-type EN10MB (Ethernet), snapshot length 262144
17:28:09.043495 IP 192.168.122.7.46428 > 192.168.122.1.53: 19061+ A? www.google.com. (32)
17:28:09.043508 IP 192.168.122.7.46428 > 192.168.122.1.53: 31350+ AAAA? www.google.com. (32)
17:28:09.043746 IP 192.168.122.1.53 > 192.168.122.7.46428: 31350 1/0/0 AAAA 2a00:1450:4026:808::2004 (60)
17:28:09.059584 IP 192.168.122.1.53 > 192.168.122.7.46428: 19061 1/0/0 A 216.58.210.164 (48)
...
```

alla tapahtuu 2 DNS kyselyä lisää ja three-way handshake (`S -> S. -> .`) `139.162.131.217` kanssa

```bash
...
17:28:10.373924 IP 192.168.122.7.35280 > 192.168.122.1.53: 978+ A? terokarvinen.com. (34)
17:28:10.373984 IP 192.168.122.7.54829 > 192.168.122.1.53: 8966+ A? gc.zgo.at. (27)
17:28:10.373992 IP 192.168.122.7.54829 > 192.168.122.1.53: 21627+ AAAA? gc.zgo.at. (27)
17:28:10.374212 IP 192.168.122.1.53 > 192.168.122.7.35280: 978 1/0/0 A 139.162.131.217 (50)
17:28:10.374704 IP 192.168.122.7.56722 > 139.162.131.217.443: Flags [S], seq 999483022, win 64240, options [mss 1460,sackOK,TS val 1378080607 ecr 0,nop,wscale 7], length 0
17:28:10.379056 IP 192.168.122.7.43675 > 192.168.122.1.53: 31281+ A? terokarvinen.com. (34)
17:28:10.379091 IP 192.168.122.7.43675 > 192.168.122.1.53: 60983+ AAAA? terokarvinen.com. (34)
17:28:10.379243 IP 192.168.122.1.53 > 192.168.122.7.43675: 31281 1/0/0 A 139.162.131.217 (50)
17:28:10.379244 IP 192.168.122.1.53 > 192.168.122.7.43675: 60983 0/0/0 (34)
17:28:10.379691 IP 192.168.122.7.56734 > 139.162.131.217.443: Flags [S], seq 240871677, win 64240, options [mss 1460,sackOK,TS val 1378080612 ecr 0,nop,wscale 7], length 0
17:28:10.391416 IP 192.168.122.1.53 > 192.168.122.7.54829: 21627 3/0/0 CNAME goatcounter.netlify.com., AAAA 2a05:d014:58f:6200::65, AAAA 2a05:d014:58f:6202::65 (120)
17:28:10.409727 IP 139.162.131.217.443 > 192.168.122.7.56722: Flags [S.], seq 2326896107, ack 999483023, win 65160, options [mss 1460,sackOK,TS val 450996719 ecr 1378080607,nop,wscale 7], length 0
17:28:10.409761 IP 192.168.122.7.56722 > 139.162.131.217.443: Flags [.], ack 1, win 502, options [nop,nop,TS val 1378080642 ecr 450996719], length 0
...
```

Alla näkyy myös gatewayn ARP-kysely, jossa huomataan, että tarkasteltavan
verkkolaitteen MAC-osoite on `52:54:00:2f:e1:e5`.


```bash
...
17:28:14.049562 ARP, Request who-has 192.168.122.7 tell 192.168.122.1, length 28
17:28:14.049576 ARP, Reply 192.168.122.7 is-at 52:54:00:2f:e1:e5, length 28
...
```

***
## Tehtävä f
> f) Vapaaehtoinen, vaikea: Mitä selainta käyttäjä käyttää? surfing-secure.pcap (Päivitys 2025-03-31 w14 ma - muutin tehtävän vapaaehtoiseksi Giang:n suosituksesta)

Muistan tästä joskus kuulleeni, että TLS handshaken ensimmäinen osa, joka ei ole
salattu, sisältää metadataa jolla voidaan luontevasti "arvata", mikä user-agent
on. Tähän löysin työkalun avustamaan wiresharkin kanssa.

> JA4+ is a suite of network fingerprinting methods by FoxIO that are easy to use and easy to share.[^4]

Seuraava komento:

```bash
$ ja4 1/surfing-secure.pcap
- stream: 0
  transport: tcp
  src: 192.168.122.7
  dst: 139.162.131.217
  src_port: 56722
  dst_port: 443
  tls_server_name: terokarvinen.com
  ja4: t13d1715h2_5b57614c22b0_5c2c66f702b0
  ja4s: t130200_1302_a56c5b993250
  ja4l_c: 17_64
  ja4l_s: 17511_54
...
```

tuo `ja4: t13d1715h2_5b57614c22b0_5c2c66f702b0` on sormenjälki, jolla voidaan
saada selville user-agentti

> Current methods and implementation details[^4]
> | Full Name | Short Name | Description |
> |---|---|---|
> | JA4 | JA4 | TLS Client Fingerprinting |

Näillä on myös tietokanta[^5], josta löytyy näitä fingerprint tietoja, sieltä saa
`json` tiedoston, joka on aika iso.

Ohessa komento, josta näkee tiedoston ensimmäisen alkion sisällön:
```bash
$ jq '.[0]' ja4db.json
{
  "application": "Nmap",
  "library": null,
  "device": null,
  "os": null,
  "user_agent_string": null,
  "certificate_authority": null,
  "verified": true,
  "notes": "",
  "ja4_fingerprint": null,
  "ja4_fingerprint_string": null,
  "ja4s_fingerprint": null,
  "ja4h_fingerprint": null,
  "ja4x_fingerprint": null,
  "ja4t_fingerprint": "1024_2_1460_00",
  "ja4ts_fingerprint": null,
  "ja4tscan_fingerprint": null
}
```

tutkitaan `ja4_fingerprint`:a

Seuraava komento käy kaikki `ja4db.json` alkiot läpi yksitellen, filtteröi sieltä
kaikki, joissa `ja4_fingerprint` on sama kuin edellä saatu sormenjälki, sitten
printataan ulos vain `user_agent_string`
```bash
$ jq '.[] | select(.ja4_fingerprint == "t13d1715h2_5b57614c22b0_5c2c66f702b0") | .user_agent_string' ja4db.json
"Mozilla/5.0 (Android 13; Mobile; rv:126.0) Gecko/126.0 Firefox/126.0"
"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:126.0) Gecko/20100101 Firefox/126.0"
"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:126.0) Gecko/20100101 Firefox/126.0"
...
```

Tässä ulos tulee lukuisia `Mozilla/5.0 NNN`-rivejä. Sen tarkemmin tätä ei taida voida
näin ainakaan selvittää. Ainakin tehtävänä oli selvittää vain selain, joten selaimeksi
voidaan määrittää näin Mozilla Firefox 5.0.

## Tehtävä g
> g) Minkä merkkinen verkkokortti käyttäjällä on? surfing-secure.pcap

Etsiskelin aluksi laiskasti, kun muistin, että OUI databaseja löytyy jostain kalin
`/usr/share/`:sta. Sattuikin löytymään jostain ihan toisesta kohtaa, kuin odotin:
```bash
$ rg "52:54:00" /usr/share/
...
/usr/share/doc/metasploit-framework/modules/exploit/linux/http/totolink_unauth_rce_cve_2023_30013.md
121:br0       Link encap:Ethernet  HWaddr 52:54:00:12:34:56
128:eth0      Link encap:Ethernet  HWaddr 52:54:00:12:34:56
135:eth1      Link encap:Ethernet  HWaddr 52:54:00:12:34:57
142:eth2      Link encap:Ethernet  HWaddr 52:54:00:12:34:58
149:eth3      Link encap:Ethernet  HWaddr 52:54:00:12:34:59
226:MAC Address: 52:54:00:12:34:56 (QEMU virtual NIC)
...
```

Varmistin vielä netistä googlaamalla, niin näyttää tosiaan olevan QEMU virtual NIC.
QEMU antaa verkkokorteille tämän osoitteen alun oletuksena. Toinen asia, joka
mielestäni voisi varmistaa, että tämä on QEMUn verkkokortti, on koneen paikallinen
IP-osoite, joka oli muotoa 192.168.122.X, joka on myös oletuksena IP-avaruus, joka
annetaan QEMU-koneille.[^6]

## Tehtävä h
> h) Millä weppipalvelimella käyttäjä on surffaillut? surfing-secure.pcap

Nämä sivut löytyvät suoraan katselemalla pcap filua
```
http://www.google.com
terokarvinen.com
gc.zgo.at
terokarvinen.goatcounter.com
commentero.terokarvinen.com
```

Käytetään samaa `ja4` työkalua, nyt katsotaan `ja4s`, eli server fingerprinting.
```bash
$ ja4 1/surfing-secure.pcap | rg "ja4s"
  ja4s: t130200_1302_a56c5b993250
  ja4s: t130200_1302_a56c5b993250
  ja4s: t130200_1301_a56c5b993250
  ja4s: t130300_1302_0ee26285a86f
  ja4s: t130300_1302_0ee26285a86f
  ja4s: t130200_1302_a56c5b993250
  ja4s: t130200_1302_a56c5b993250
  ja4s: t130200_1301_a56c5b993250
  ja4s: q130300_1301_6bbbaf601ed8

# poistetaan duplikaatit
$ ja4 1/surfing-secure.pcap | rg "ja4s" | sort -u
  ja4s: q130300_1301_6bbbaf601ed8
  ja4s: t130200_1301_a56c5b993250
  ja4s: t130200_1302_a56c5b993250
  ja4s: t130300_1302_0ee26285a86f
```

Katsotaan, josko tietokannasta löytyy palvelimia

```bash
$ jq '.[] | select(.ja4s_fingerprint == "q130300_1301_6bbbaf601ed8") | .application' ja4db.json
# (tyhjä)

$ jq '.[] | select(.ja4s_fingerprint == "t130200_1301_a56c5b993250") | .application' ja4db.json
"Sliver Agent"
"Sliver Agent"

$ jq '.[] | select(.ja4s_fingerprint == "t130200_1302_a56c5b993250") | .application' ja4db.json
# (tyhjä)

$ jq '.[] | select(.ja4s_fingerprint == "t130300_1302_0ee26285a86f") | .application' ja4db.json
# (tyhjä)
```

Sliver Agent sormenjälki näyttää tulevan osoitteesta `gc.zgo.at` ja `terokarvinen.goatcounter.com`.
Tämä taitaa olla väärä positiivinen, koska Sliver Agent viittaisi johonkin C2 palvelimeen ja pcap:ssa
pitäisi varmaan näkyä muutakin epäilyttävää toimintaa.

## Tehtävä i
> i) Analyysi. Sieppaa pieni määrä omaa liikennettäsi. Analysoi se, eli selitä mahdollisimman perusteellisesti, mitä tapahtuu. (Tässä pääpaino on siis analyysillä ja selityksellä, joten liikennettä kannattaa ottaa tarkasteluun todella vähän - vaikka vain pari pakettia. Gurut huomio: Selitä myös mielestäsi yksinkertaiset asiat.)

Sieppasin kolmivaiheisen kättelyn sekä verkkosivun pyynnön+palvelemisen

Taustana: 192.168.122.50 (kali) hakee palvelimelta 192.168.50.175 sivua. Tätä ennen
DNS-kysely on tehty ja tässä näkyy vain tuo yllä mainittu osa

Käydään rivi riviltä läpi:
```bash
$ tshark -r curlexample.pcapng
```

Kali aloittaa kolmivaiheisen kättelyn lähettämällä SYN-paketin palvelimelle (seq=0).

`Seq` on pakettien sekvenssinumero. `Ack` on näitä vastaava numero, jolla saaja kertoo
nähneensä tietyn paketin sekvenssinumeron perusteella.

`Win` kertoo vastaanottajan suurimman "window size":n, jonka tämä ottaa vastaan[^8]

`Len` kertoo tässä TCP:n kontekstissa TCP segmentin (header+payload) suuruuden[^9]

`MSS` on maximum segment size, TCP segmentin suurin koko joka hyväksytään[^9].

`SACK_PERM` on "Selective acknowledgment permitted". Tämä näyttää olevan jokin
reaktio virhetilanteisiin johtaneisiin TCP yhteyksiin, joka korjattiin vuonna 1996[^8].

```bash
1 0.000000000 192.168.122.50 → 192.168.50.175 TCP 74 52688 → 80 [SYN]
Seq=0 Win=64240 Len=0 MSS=1460 SACK_PERM TSval=1092017341 TSecr=0 WS=128
```

`TSval` on lähettäjän aikaleima. `TSecr` on vastaanottajan kaikuvastaus (echo reply)[^7]

palvelin lähettää SYN ja ACK takaisin kalille, kertoen, että sai äskeisen SYN-paketin (seq=0 ja ack=1)

```bash
2 0.000163379 192.168.50.175 → 192.168.122.50 TCP 74 80 → 52688 [SYN, ACK]
Seq=0 Ack=1 Win=65160 Len=0 MSS=1460 SACK_PERM TSval=4285584289 TSecr=1092017341 WS=128
```

Kali lähettää palvelimelle takaisin ACK, kertoen saaneensa palvelimen SYN-paketin (seq=1 ja ack=1)

```bash
3 0.000194734 192.168.122.50 → 192.168.50.175 TCP 66 52688 → 80 [ACK]
Seq=1 Ack=1 Win=64256 Len=0 TSval=1092017341 TSecr=4285584289
```

Kun kolmivaiheinen kättely on valmis, kali kysyy (GET) palvelimelta päähakemistoa /, protokollana HTTP/1.1

```bash
4 0.000248677 192.168.122.50 → 192.168.50.175 HTTP 142 GET / HTTP/1.1
```

Palvelin vastaa ACK, saaneensa äskeisen GET pyynnön

```bash
5 0.000296832 192.168.50.175 → 192.168.122.50 TCP 66 80 → 52688 [ACK]
Seq=1 Ack=77 Win=65152 Len=0 TSval=4285584289 TSecr=1092017341
```

Palvelin lähettää paketin, joka sisältää tarvittavat HTTP-paketin tiedot, RFC-standardien mukaisesti

```bash
6 0.000970391 192.168.50.175 → 192.168.122.50 HTTP 289 HTTP/1.1 200 OK  (text/plain)
```


# Lähteet
[^1]: Tero Karvinen, Verkkoon tunkeutuminen ja tiedustelu, https://terokarvinen.com/verkkoon-tunkeutuminen-ja-tiedustelu/
[^2]: Kali inside QEMU/LibVirt with virt-manager (Guest VM), https://www.kali.org/docs/virtualization/install-qemu-guest-vm/
[^3]: Patrik Mihelson-Adamson, H0, https://github.com/p-lemonish/course-network-attacks-and-reconnaissance/blob/main/0/h0.md
[^4]: JA4+™ Network Fingerprinting, FoxIO-LLC, https://github.com/FoxIO-LLC/ja4
[^5]: JA4+ Database, FoxIO-LLC, https://ja4db.com/
[^6]: KVM Networking, Ubuntu, https://help.ubuntu.com/community/KVM/Networking
[^7]: Request for Comments: 7323, TCP Extensions for High Performance, 2014, Internet Engineering Task Force (IETF), https://www.rfc-editor.org/rfc/rfc7323.txt
[^8]: Transmission Control Protocol, Wikipedia, https://en.wikipedia.org/wiki/Transmission_Control_Protocol
[^8]: Maximum Segment Size, Wikipedia, https://en.wikipedia.org/wiki/Maximum_segment_size
